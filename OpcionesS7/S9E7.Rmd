---
title: "S7E7"
output:
  html_document:
    df_print: paged
editor_options:
  markdown:
    wrap: 72
---

#Borro todos los datos almacenados

```{r}
rm(list = ls())
graphics.off()
```

#Cargo las librerías que podría llegar a necesitar

```{r}
library (tidyverse)
#library(knitr)
#library (purrr)
#library (ggplot2)
#library (tidyr)
#library (quantmod)
library(flextable)
```

**Nota arbitrajes**

Call barato → Comprar call y vender cartera replicante (short
subycaente + bono).

Call caro → Vender call y comprar cartera replicante (long subyacente +
bono).

Put barato → Comprar put y vender cartera replicante (short subyacente +
préstamo).

Put caro → Vender put y comprar cartera replicante (long subyacente +
préstamo).

#Datos del ejercicio

```{r}
S <- 40               #Precio
sigma <- 0.25         #Volatilidad
rfloc <- 0.30         #Tasa de descuento local
rfext <- 0.05         #Tasa de descuento extranjera (rendimiento del activo)
Vto <- 4/12           #Cantidad de años al vto.
Deltat <- Vto/2       #Intervalo de tiempo
k <- 42               #Strike
```

#Subyacente Calcular u y d

```{r}
u <- exp(sigma * sqrt(Deltat))
d <- 1/u
```

#Calcular PNR Probabilidad Neutral a Riesgo

```{r}
PNR <- (S* exp((rfloc - rfext) * Deltat) - S * d) / (S * u - S * d) #rfext (rendimiento) debe restarse de la tasa de descuento
q <- 1-PNR
```

## Punto A: Construir árbol binomial del subyacente

```{r}
ArbolSuby <- tibble  (
              t0 = c(S, NA, NA),
              t1 = c (S * u, S * d, NA),
              t2 = c (S * u * u, S * u* d, S * d * d)
)

ArbolSuby %>% flextable() #formato más bonito

print(ArbolSuby)
```

## Punto B: Construir árbol de coberturas

```{r}
ArbolCob <- tibble  (
  t0 = c (NA, NA, NA),
  t1 = c (NA, NA, NA),
  # comienza por calcular el último valor, con un mínimo de 0 (condición para ejercer)
  t2 = c (max(k - ArbolSuby$t2[1] , 0),
          max(k - ArbolSuby$t2[2] , 0),
          max(k - ArbolSuby$t2[3] , 0))) %>% 
  # luego calcular para atrás
  mutate (
    t1 = c(
      (t2[1] * PNR + t2[2] * q) * exp(-rfloc * Deltat),  
      (t2[2] * PNR + t2[3] * q) * exp(-rfloc * Deltat),
      NA
    ),
  # y nuevamente para atrás
    t0 = c(
      (t1[1] * PNR + t1[2] * q) * exp(-rfloc * Deltat),  
      NA,
      NA
    )
  )

ArbolCob %>% flextable()

print(ArbolCob)
```

## Punto D: Replicar portafolio para la opción put

```{r}
pM <- 1.5     #precio de mercado
```

¿Cuánto debe dar el ejercicio?

```{r}
RdoTeorico <- ArbolCob$t0[1] - pM
print (round(RdoTeorico, 6))
```

#Árbol de Deltas

```{r}
#Calcular delta entre t(0) y t(1)
#No es necesario calcular todo. Lo hago igual por las dudas.

Delta0 <-   (ArbolCob$t1[1] - ArbolCob$t1[2]) /
  (ArbolSuby$t1[1] - ArbolSuby$t1[2])

DeltaUp <-   (ArbolCob$t2[1] - ArbolCob$t2[2]) /
  (ArbolSuby$t2[1] - ArbolSuby$t2[2])

DeltaDown <-   (ArbolCob$t2[2] - ArbolCob$t2[3]) /
  (ArbolSuby$t2[2] - ArbolSuby$t2[3])

ArbolDelta <- tibble(
  t0 = c(Delta0, NA, NA),
  t1 = c(DeltaUp, DeltaDown, NA),
  t2 = c(NA, NA, NA)  # No se calcula delta en el último nivel
)

ArbolDelta %>% flextable()
```

#Calcular los flujos de fondos para replicar la cartera

t=0

Aprovechar que el put está más barato que su valor teórico, armando una
cartera que replique su valor, sin riesgo, y con ganancias aseguradas si
se mantiene hasta el vencimiento.

```{r}

CompraPut0 <- -pM
Cantidad0 <- Delta0 * exp (-rfext * Deltat) #Cálculo para la cantidad de subyacentes a comprar, descontando su rendimiento (no tiene que ver con el descuento de tasa de interés)
CompraAccion0 <- Cantidad0 * S 
Prestamo0 <- - (CompraPut0 + CompraAccion0)
Flujo0 <- CompraPut0 + CompraAccion0 + Prestamo0


```

t=1 Escenario Up-Down Rebalanceo la cartera Como sube el valor, vendo el
subyacente. ¿Cuánto debo vender? Lo que preciso menos lo que tengo

```{r}
Necesidadt1 <- DeltaUp * exp (-rfext * Deltat)  #Cálculo para la cantidad de subyacentes a comprar, descontando su rendimiento (no tiene que ver con el descuento de tasa de interés)
Cantidadt1 <- Necesidadt1 - Delta0              #Lo que necesito menos lo que tengo
Preciot1 <- ArbolSuby$t1[1]                     # 1 corresponde al nodo Up
VentaAcciont1 <- Cantidadt1 * Preciot1
Inversiont1 <- -VentaAcciont1                   # Como vendo acciones el flujo de fondos es positivo por lo que se invierte
Flujo1 <- VentaAcciont1 + Inversiont1           # El flujo de fondos debe dar 0

```

t=2 Cierro todas las posiciones

```{r}
#Venta de las acciones
Preciot2 <- ArbolSuby$t2[2]                             # 2 corresponde al nodo Donw
Cantidadt2 <- -Necesidadt1 * exp (rfext * Deltat)       # La cantidad necesaria en 2 es 0, por lo cual se revierte la necesidad de 1 
VentaAcciont2 <- Preciot2 * Cantidadt2
Prestamo0Act <- -Prestamo0 * exp (rfloc * Deltat * 2)   # el préstamo es actualizado a la tasa local 
Inversiont1Act <- - Inversiont1 * exp (rfloc * Deltat)  # la invesrsión es  actualizada a la tasa local
FlujoPut2 <- ArbolCob$t2[2]                             # se elige el nodo correspondiente
FlujoRf2 <- Prestamo0Act + Inversiont1Act
Flujo2 <- FlujoPut2 + VentaAcciont2 + FlujoRf2
Flujo2Desc <- Flujo2 * exp (-rfloc * Deltat * 2) 
```

Mostrar en tabla

```{r}
arbitraje <- tibble(
  Momento = c("t0", "t1 (up)", "t2 (up-down)"),
  Put = c(CompraPut0, 0, FlujoPut2),
  Subyacente = c(CompraAccion0, VentaAcciont1, VentaAcciont2),
  PrestamoColocacion = c(Prestamo0, Inversiont1 , FlujoRf2),
  Total = c(0, 0, Flujo2)
)

flextable(arbitraje)
```

Verificar

```{r}
all.equal(RdoTeorico, Flujo2Desc, tolerance = 1e-10)

```

## Punto E. Si se negocia un put americano con igual subyacente, strike y vencimiento, calcule la “prima por ejercicio anticipado”.

```{r}
#Solo cambian los nodos intermedios (t=1)

#En cada momento se debe comparar el valor esperado actualizado y el de ejercer inmediatamente.

Put_t1_Amer <- c(
  max(k - ArbolSuby$t1[1], ArbolCob$t1[1]),  # Nodo "up" en t=1
  max(k - ArbolSuby$t1[2], ArbolCob$t1[2])   # Nodo "down" en t=1
)

# Calcular el valor de la opción en t=0 como valor esperado descontado desde los nodos t=1
Put_t0_Amer_Opcion1 <-  ((PNR * Put_t1_Amer[1]) + (1 - PNR) * Put_t1_Amer[2]) * exp(-rfloc * Deltat)

# Nodo inicial (t=0) para el americano
Put_t0_Amer <- max(k - S, Put_t0_Amer_Opcion1) #El valor del put americano es el mayor entre ejercerlo en el momento y el valor esperado actualizado, con PRN, de los siguientes nodos.

# Prima por ejercicio anticipado
Prima_EjAnticipado <- Put_t0_Amer - ArbolCob$t0[1] 

paste0("La prima por ejercicio anticipado es: ", Prima_EjAnticipado)
```

Árbol para el put americano

```{r}
putamericano <- tibble(
  Momento = c("t0", "t1", "t2"),
  Momento_0 = c(Put_t0_Amer, 0, 0),
  Momento_1 = c(Put_t1_Amer[1], Put_t1_Amer[2],0),
  Momento_2 = c(max(k - ArbolSuby$t2[1] , 0), max(k - ArbolSuby$t2[2] , 0) , max(k - ArbolSuby$t2[3] , 0)))



flextable(putamericano)
```
